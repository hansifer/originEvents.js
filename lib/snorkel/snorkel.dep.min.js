// snorkel.js 0.1.0
// https://github.com/hansifer/snorkel.js
// (c) 2013-2014 Hans Meyer; Licensed MIT
//
// Depends:
// underscore (https://github.com/jashkenas/underscore)
// originEvents (https://github.com/hansifer/originEvents.js)

(function(a){var b=this,c=b.localStorage,d={};d.snorkelInit=b.snorkelInit;var e,f,g=[],h="0.1.0",i=0,j=function(a){return _.isString(a)&&a.length||_.isFinite(a)},k=function(a){return _.isString(a)||_.isFinite(a)||_.isBoolean(a)||_.isObject(a)&&!_.isFunction(a)||_.isNull(a)||_.isUndefined(a)},l=function(a){if(!j(a))throw"snorkel invalid key "+A(a,"");return!0},m=function(a){if(!k(a))throw"snorkel invalid value "+A(a,"");return!0},n=function(a){return JSON.stringify(o(a))},o=function(a,b){var c,d,e;if(_.isDate(a))return"\\/Date("+a.toISOString()+")\\/";if(_.isRegExp(a))return"\\/RegExp("+a.source+")"+(a.global||a.ignoreCase||a.multiline?"("+(a.global?"g":"")+(a.ignoreCase?"i":"")+(a.multiline?"m":"")+")":"")+"\\/";if(_.isUndefined(a))return"\\/undefined\\/";if(_.isObject(a)){if(b){if(e=_.find(b,function(b){return b.orig===a}))return e.clone}else b=[];d=_.isArray(a)?[]:{},b.push({orig:a,clone:d});for(c in a)d[c]=o(a[c],b);return d}return a},p=function(a){if(""===a)return null;if("undefined"!==a)return q(JSON.parse(a))},q=function(b,c){var d;if(_.isString(b))return r(b)||s(b)||("\\/undefined\\/"===b?a:b);if(_.isObject(b)){if(c){if(_.contains(c,b))return b}else c=[];c.push(b);for(d in b)b[d]=q(b[d],c)}return b},r=function(a){return _.isString(a)&&"\\/Date("===a.substring(0,7)?new Date(a.substring(7,a.indexOf(")"))):void 0},s=function(a){var b,c;return _.isString(a)&&"\\/RegExp("===a.substring(0,9)?(b=a.indexOf(")",9),c=a.substring(9,b),b=a.indexOf("(",b),-1!==b?new RegExp(c,a.substring(b+1,a.indexOf(")",b))):new RegExp(c)):void 0},t=function(a){return G(a)?p(c.getItem(a)):void 0},u=function(a,b,d){var e;_.isUndefined(d)&&(d=n(b)),this.canEmitLocally()&&g.length||this.canEmitRemotely()?G(a)?(e=C(a),c.setItem(a,d),v.call(this,"updated",a,b,e)):(c.setItem(a,d),v.call(this,"added",a,b)):c.setItem(a,d)},v=function(a,b,c,d){j(b)&&(this.canEmitRemotely()&&f.trigger("snorkel",{type:a,key:b,value:c,oldValue:d}),this.canEmitLocally()&&w(a,b,c,d))},w=function(a,b,c,d,e){var f,h;for(b=b.toString(),f=0;f<g.length;f++){for(h=0;h<g[f].k.length&&(!g[f].k[h].test(b)||"updated"===a&&g[f].a!==!0&&_.isEqual(c,d)||!("all"===g[f].s||"remote"===g[f].s&&e||"local"===g[f].s&&!e));h++);(0===h||h<g[f].k.length)&&g[f].h(a,b,c,d,e)}},x=function(a){if(j(a))return new RegExp("^"+z(a)+"$");if(!_.isRegExp(a))throw"snorkel invalid key selector "+A(a,"");return a},y=function(a,b){w(b.type,b.key,b.value,b.oldValue,!0)},z=function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},A=function(a,b){try{return _.isObject(a)?_.isFunction(a)?"[function]":_.isRegExp(a)?"[RegExp] "+a.source:JSON.stringify(a):a+""}catch(c){}return b},B=function(){var a,b=arguments.length;if(b>2)throw"snorkel call failed. 0-2 arguments expected, "+b+" present.";return b?(a=arguments[0],2===b?this.set(a,arguments[1]):!_.isObject(a)||_.isArray(a)||_.isRegExp(a)?C(a):this.set(a)):C()},C=function(a,b){var d,e;if(arguments.length>2)throw"snorkel get failed. 0-2 arguments required, "+arguments.length+" present.";if(!arguments.length){for(d={},e=0;e<c.length;e++)a=c.key(e),d[a]=C(a);return d}return _.isRegExp(a)?C(K(!0,a)):_.isArray(a)?_.flatten(_.map(a,function(a){return C(a,b)})):(l(a),_.isUndefined(b)||G(a)?t(a):_.isFunction(b)?b(a):b)},D=function(a,b){var c,d;if(1===arguments.length){if(!_.isObject(a)||_.isArray(a)||_.isRegExp(a))throw"snorkel set failed. Calling set() with a single argument requires a set object, but actual argument is "+A(a,"");return _.each(a,function(a,b){l(b),m(a)}),d=[],_.each(a,function(a,b){u.call(this,b,a),d.push(a)},this),d}if(2!==arguments.length)throw"snorkel set failed. A single set object or 2 arguments required, "+arguments.length+" present.";return m(b),_.isRegExp(a)?D.call(this,K(!0,a),b):(_.isArray(a)?(a=_.flatten(a),_.each(a,function(b,c){_.isRegExp(b)?a[c]=K(!0,b):l(b)}),a=_.uniq(_.flatten(a)),c=n(b),_.each(a,function(a){u.call(this,a,b,c)},this)):l(a)&&u.call(this,a,b),b)},E=function(a,b){var d;if(arguments.length>2)throw"snorkel remove failed. 0-2 arguments required, "+arguments.length+" present.";return arguments.length?_.isRegExp(a)?E.call(this,K(!0,a)):_.isArray(a)?(a=_.flatten(a),_.each(a,function(b,c){_.isRegExp(b)?a[c]=K(!0,b):l(b)}),a=_.uniq(_.flatten(a)),_.map(a,function(a){return this.remove(a,b)},this)):(l(a),d=C(a,b),G(a)&&(c.removeItem(a),(this.canEmitLocally()&&g.length||this.canEmitRemotely())&&v.call(this,"removed",a,d)),d):(d=M(),c.length&&(c.clear(),(this.canEmitLocally()&&g.length||this.canEmitRemotely())&&_.each(d,function(a,b){v.call(this,"removed",b,a)},this)),d)},F=function(){this.remove()},G=function(a){return!!K(!1,a,!0).length},H=function(b){return c.key(b)||a},I=function(){return c.length},J=function(a){var b,d;for(d=0;d<c.length;d++)b=c.key(d),a(b,C(b),d);return d},K=function(b,d,e,f){var g;if(f||(f=[]),1===arguments.length&&(_.isBoolean(b)||(d=b,b=a)),_.isArray(d)){for(g=0;g<d.length;g++)if(K(!1,d[g],e,f).length&&e)return f;f=_.uniq(_.flatten(f))}else{if(!(_.isUndefined(d)||_.isRegExp(d)||j(d)))throw"snorkel keys() failed. Not a valid key selector: "+A(d,"");for(g=0;g<c.length;g++){if(!d||_.isRegExp(d)&&d.test(c.key(g)))f.push(c.key(g));else if(j(d)&&d.toString()===c.key(g)){f.push(c.key(g));break}if(e&&f.length)return f}}return b?f.sort():f},L=function(){var a,b=[];for(a=0;a<c.length;a++)b.push(C(c.key(a)));return b},M=function(){return C()},N=function(a,b,c){if(arguments.length<1||arguments.length>3)throw"snorkel on() call failed. 1-3 arguments expected, "+arguments.length+" present.";if(!_.isFunction(a))throw"snorkel on() call failed. Expected function as first argument, received "+A(a,"");_.isUndefined(b)||(_.isArray(b)?(b=_.flatten(b),_.each(b,function(a,c){b[c]=x(a)})):b=x(b));var d=c&&("local"===c.scope&&"local"||"remote"===c.scope&&"remote")||"all",e=_.find(g,function(b){return b.h===a});e||g.push(e={s:d,a:!(!c||!c.alwaysFireOnUpdate),h:a,k:[]}),e.k=_.isUndefined(b)?[]:_.uniq(e.k.concat(b),function(a){return a.source+a.ignoreCase}),("remote"===d||"all"===d)&&(i||f.on("snorkel",y,"remote"),i++)},O=function(a){var b,c;_.isFunction(a)&&(c=_.find(g,function(c,d){return c.h===a?(b=d,!0):!1}),_.isUndefined(b)||(("remote"===c.s||"all"===c.s)&&(i--,i||f.off("snorkel",y)),g.splice(b,1)))},P=function(a){return arguments.length&&(this._canEmitLocally=a),this._canEmitLocally},Q=function(a){return arguments.length&&(this._canEmitRemotely=a),this._canEmitRemotely},R=function(a,c){var d=function(){return B.apply(d,arguments)};return d.get=C,d.set=D,d.remove=E,d.clear=F,d.exists=d.has=G,d.key=H,d.size=d.count=I,d.each=J,d.keys=K,d.values=L,d.all=d.items=M,d.on=d.addKeyListener=N,d.off=d.removeKeyListener=O,d.canEmitLocally=P,d.canEmitRemotely=Q,d.decodeValue=p,d.version=h,d.canEmitLocally(_.isUndefined(a)||a),d.canEmitRemotely(_.isUndefined(c)||c),f||(f=!0,f=b.originEventsInit(!1,!0)),d};for(e in d)b[e]=R}).call(this);